id: swift-webview-config-allows-universal-file-access-swift
severity: warning
language: swift
message: >-
      Webviews were observed that do not disable access to application files.
      If the WebView does not require loading content from the local filesystem
      of the application, this setting should be disabled.
note: >-
  [CWE-272] Least Privilege Violation.
  [REFERENCES]
      - https://mas.owasp.org/MASVS/controls/MASVS-PLATFORM-2/
utils:
  match_pattern_two:
    kind: call_expression
    all:
      - has:
          stopBy: end
          kind: navigation_expression
          all:
            - has:
                stopBy: neighbor
                kind: simple_identifier
                pattern: $W
      - has:
                stopBy: end
                kind: navigation_suffix
                has:
                  stopBy: end
                  kind: simple_identifier
                  regex: '^setValue$'
      - has:
          stopBy: neighbor
          kind: call_suffix
          all:
            - has:
                stopBy: end
                kind: value_argument
                has:
                  stopBy: neighbor
                  kind: boolean_literal
                  regex: '^true$'
            - has:
                stopBy: end
                kind: value_argument
                all:
                  - has:
                      stopBy: end
                      kind: simple_identifier
                      regex: '^forKey$'
                  - has:
                      stopBy: neighbor
                      kind: line_string_literal
                      has:
                        stopBy: neighbor
                        kind: line_str_text
                        regex: '^allowUniversalAccessFromFileURLs$'
      - follows:
          stopBy: end
          kind: property_declaration
          all:
            - has:
                stopBy: end
                kind: pattern
                has: 
                  stopBy: neighbor
                  kind: simple_identifier
                  pattern: $W
            - any:
                - has:
                   stopBy: neighbor
                   kind: navigation_expression
                - has:
                    stopBy: end
                    kind: call_expression
                    has:
                      stopBy: neighbor
                      kind: simple_identifier
                      regex: '^WKWebView$'
               
      - not:
          precedes:
            stopBy: neighbor
            kind: call_expression
            all:
            - has:
               stopBy: neighbor
               kind: navigation_expression
               all:
               - has:
                  stopBy: neighbor
                  kind: simple_identifier
                  pattern: $W
               - has:
                   stopBy: neighbor
                   kind: navigation_suffix
                   has:
                    stopBy: neighbor
                    kind: simple_identifier
                    regex: '^setValue$'
            - has:
               stopBy: neighbor
               kind: call_suffix
               all:
               - has:
                  stopBy: end
                  kind: value_argument
                  has:
                   stopBy: neighbor
                   kind: boolean_literal
                   regex: '^false$'
               - has:
                  stopBy: end
                  kind: value_argument
                  all:
                  - has:
                      stopBy: end
                      kind: simple_identifier
                      regex: '^forKey$'
                  - has:
                      stopBy: neighbor
                      kind: line_string_literal
                      has:
                        stopBy: neighbor
                        kind: line_str_text
                        regex: '^allowUniversalAccessFromFileURLs$'

  match_pattern_one:
    kind: call_expression
    all:
    - has:
       stopBy: neighbor
       kind: navigation_expression
       all:
        - has:
            stopBy: neighbor
            kind: navigation_expression
            all:
              - has:
                  stopBy: end
                  kind: simple_identifier
                  pattern: $L
              - has:
                  stopBy: neighbor
                  kind: navigation_suffix
                  has:
                    stopBy: neighbor
                    kind: simple_identifier
                    regex: '^configuration$'
        - has:
            stopBy: neighbor
            kind: navigation_suffix
            has:
              stopBy: neighbor
              kind: simple_identifier
              regex: '^setValue$'
    - has:
       stopBy: neighbor
       kind: call_suffix
       has:
         stopBy: neighbor
         kind: value_arguments
         all:
           - has:
               stopBy: neighbor
               kind: value_argument
               has:
                 stopBy: neighbor
                 kind: boolean_literal
                 regex: '^true$'
           - has:
               stopBy: neighbor
               kind: value_argument
               all:
                 - has:
                     stopBy: neighbor
                     kind: simple_identifier
                     regex: '^forKey$'
                 - has:
                     stopBy: neighbor
                     kind: line_string_literal
                     has:
                       stopBy: neighbor
                       kind: line_str_text
                       regex: '^allowUniversalAccessFromFileURLs$'
    - follows:
        stopBy: neighbor
        kind: property_declaration
        all:
          - has:
              stopBy: end
              kind: pattern
              has:
                stopBy: neighbor
                kind: simple_identifier
                pattern: $L
          - has:
              stopBy: neighbor
              kind: call_expression
rule:
  kind: call_expression
  any:
    - matches: match_pattern_two
    - matches: match_pattern_one
