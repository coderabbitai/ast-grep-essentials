id: pkcs5-hardcoded-secret-swift
language: swift
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798]: Use of Hard-coded Credentials
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_with_try:
    kind: call_expression
    all:
      - has:
          stopBy: end
          kind: try_expression
          all:
            - has:
                stopBy: end
                kind: navigation_expression
                has:
                  stopBy: end
                  kind: simple_identifier
                  regex: "^PKCS5$"
            - has:
                stopBy: end
                kind: call_suffix
                has:
                  stopBy: end
                  kind: value_argument
                  all:
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: name
                        regex: "^password$"
                    - has:
                        field: value
                        kind: simple_identifier
                        pattern: $R
    follows:
      stopBy: end
      kind: property_declaration
      has:
        stopBy: end
        kind: pattern
        has:
          stopBy: end
          kind: simple_identifier
          pattern: $R

  match_call_expression:
    kind: call_expression
    has:
      stopBy: end
      kind: navigation_expression
      all:
        - has:
            stopBy: end
            kind: simple_identifier
            regex: "^PKCS5$"
        - has:
            stopBy: end
            kind: value_argument
            all:
              - has:
                  stopBy: end
                  kind: simple_identifier
                  regex: "^password$"
              - has:
                  stopBy: end
                  kind: line_string_literal
                  has:
                    stopBy: end
                    kind: line_str_text

  match_without_try:
    kind: call_expression
    all:
      - has:
          stopBy: end
          kind: navigation_expression
          has:
            stopBy: end
            kind: simple_identifier
            regex: "^PKCS5$"
      - has:
          stopBy: end
          kind: call_suffix
          has:
            stopBy: end
            kind: value_argument
            all:
              - has:
                  stopBy: end
                  kind: simple_identifier
                  field: name
                  regex: "^password$"
              - has:
                  stopBy: end
                  kind: simple_identifier
                  field: value
                  pattern: $T
      - follows:
          stopBy: end
          kind: property_declaration
          has:
            kind: pattern
            has:
              stopBy: end
              kind: simple_identifier
              pattern: $T

rule:
  any:
    - matches: match_call_expression
    - matches: match_with_try
    - matches: match_without_try
